

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Deadheading in Ride-Hailing &#8212; AI Search Algorithms for Smart Mobility</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script src="../../../_static/tabs.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/PeopleMobilityProblems/deadheading/Deadheading';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Logistics Problems" href="../../LogisticsProblems/index.html" />
    <link rel="prev" title="Multi-Criteria Routing" href="../multicriteriarouting/MultiCriteriaRouting.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/sm.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../../_static/sm.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    AI Search Algorithms for Smart Mobility
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../GettingStarted/index.html">Getting Started</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../IntroGeoScience/index.html">Introduction to Geospatial Data Science</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../IntroGeoScience/SpatialData.html">Spatial Data and Geographic Information System (GIS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../IntroGeoScience/Projection.html">Projection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../IntroGeoScience/Visualization.html">Visualization</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../GraphSearchAlgorithms/index.html">Graph Search Algorithms</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../GraphSearchAlgorithms/RoadGraph.html">From Road Network to Graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../GraphSearchAlgorithms/GraphSearch.html">Graph Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../GraphSearchAlgorithms/BlindSearch.html">Blind Search Algorithms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../GraphSearchAlgorithms/InformedSearch.html">Informed Search Algorithms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../GraphSearchAlgorithms/SearchComparison.html">Search Algorithm Comparison</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../TrajectoryAlgorithms/index.html">Trajectory-based Algorithms</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../TrajectoryAlgorithms/TabuSearch.html">Tabu Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../TrajectoryAlgorithms/SimulatedAnnealing.html">Simulated Annealing</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../EvolutionaryComputingAlgorithms/index.html">Evolutionary Computing Algorithms</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../EvolutionaryComputingAlgorithms/GeneratingInitialPopulations.html">Generating Initial Populations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../EvolutionaryComputingAlgorithms/GeneticAlgorithms.html">Genetic Algorithms</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../SwarmIntelligenceAlgorithms/index.html">Swarm Intelligence Algorithms</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../SwarmIntelligenceAlgorithms/ParticleSwarmOptimization.html">Particle Swarm Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../SwarmIntelligenceAlgorithms/AntColonyOptimization.html">Ant Colony Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../SwarmIntelligenceAlgorithms/ArtificialBeeColony.html">Artificial Bee Colony</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../SwarmIntelligenceAlgorithms/FireflyAlgorithm.html">Firefly Algorithm</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../LearnToSearch/index.html">Learn to Search</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../LearnToSearch/GeometricDeepLearning.html">Geometric Deep Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../LearnToSearch/GraphNeuralNetworks.html">Graph Neural Networks (GNN)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../LearnToSearch/AttentionMechanisms.html">Attention Mechanisms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../LearnToSearch/ReinforcementLearning.html">Reinforcement Learning</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../index.html">People Mobility Problems</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../carsharing/CarSharing.html">Car-Sharing Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../trip_itinerary_planning/TIP.html">Trip Itinerary Planning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multicriteriarouting/MultiCriteriaRouting.html">Multi-Criteria Routing</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Deadheading in Ride-Hailing</a></li>

</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../LogisticsProblems/index.html">Logistics Problems</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../LogisticsProblems/delivery_GA.html">Delivery Vehicle Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../LogisticsProblems/eco_routing.html">Eco-efficient Delivery</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../InfrastructureProblems/index.html">Infrastructure Problems</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../InfrastructureProblems/emergency_vehicle/emergency_vehicle.html">Emergency Dispatch and Routing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../ToolsAndPythonLibraries/index.html">Tools and Python Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Datasets.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../References.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/SmartMobilityAlgorithms/book" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/content/PeopleMobilityProblems/deadheading/Deadheading.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Deadheading in Ride-Hailing</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Deadheading in Ride-Hailing</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#data">Data</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-classes">Problem Classes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rider">Rider</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#driver">Driver</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#coord-node">Coord (Node)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-sampler">Data Sampler</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot">Plot</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-formulation">Problem Formulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#formulation">Formulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-class">Solution Class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-1-simulated-annealing">Solution 1: Simulated Annealing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solver-class">Solver Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization">Visualization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-2-genetic-algorithm">Solution 2: Genetic Algorithm</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Solver Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize">Visualize</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-3-grey-wolf-algorithm">Solution 3: Grey Wolf Algorithm</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wolf-class">Wolf Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Solver Class:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Visualize</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="deadheading-in-ride-hailing">
<h1>Deadheading in Ride-Hailing<a class="headerlink" href="#deadheading-in-ride-hailing" title="Permalink to this heading">#</a></h1>
<p><strong>Authors:</strong> Juan Carrillo, Anas Mahmoud and Sheran Cardoza<br>
<strong>Course:</strong> ECE1724H: Bio-inspired Algorithms for Smart Mobility - Fall 2021<br>
<strong>Instructor:</strong> Dr. Alaa Khamis<br>
<strong>Department:</strong> Edward S. Rogers Sr. Department of Electrical &amp; Computer Engineering, University of Toronto</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>Ridesharing is one of several on-demand mobility services gaining momentum in recent years
and represents a flexible and convenient alternative for transportation. Despite its
attractiveness, ridesharing also causes undesired effects such as increased traffic and
emissions. In this project, we study specifically the problem of ridesharing vehicles roaming
without passengers, also known as deadheading.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">statistics</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">cos</span>
<span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span>

<span class="c1"># Data and plotting</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas.io</span> <span class="kn">import</span> <span class="n">parsers</span>
<span class="kn">import</span> <span class="nn">folium</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># Mobility</span>
<span class="kn">import</span> <span class="nn">osmnx</span>
<span class="kn">from</span> <span class="nn">smart_mobility_utilities.common</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">smart_mobility_utilities.common</span> <span class="kn">import</span> <span class="n">cost</span>
<span class="kn">from</span> <span class="nn">smart_mobility_utilities.viz</span> <span class="kn">import</span> <span class="n">draw_route</span>
<span class="kn">from</span> <span class="nn">smart_mobility_utilities.search</span> <span class="kn">import</span> <span class="n">dijkstra</span><span class="p">,</span> <span class="n">astar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="nn">Input In [1],</span> in <span class="ni">&lt;cell line: 18&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span> <span class="c1"># Mobility</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="kn">import</span> <span class="nn">osmnx</span>
<span class="ne">---&gt; </span><span class="mi">18</span> <span class="kn">from</span> <span class="nn">smart_mobility_utilities.common</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span> <span class="kn">from</span> <span class="nn">smart_mobility_utilities.common</span> <span class="kn">import</span> <span class="n">cost</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span> <span class="kn">from</span> <span class="nn">smart_mobility_utilities.viz</span> <span class="kn">import</span> <span class="n">draw_route</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;smart_mobility_utilities&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="data">
<h1>Data<a class="headerlink" href="#data" title="Permalink to this heading">#</a></h1>
<p>The data source for this example contains 175 delivery records for addresses in the Greater Toronto Area (GTA).</p>
<p>These entries with latitude and longitude information are then converted into OSM Node IDs (closest node). One location is assigned per vehicle as a “initial depot location”. Each rider is assigned a pickup node and a dropoff node.</p>
<section id="problem-classes">
<h2>Problem Classes<a class="headerlink" href="#problem-classes" title="Permalink to this heading">#</a></h2>
<section id="rider">
<h3>Rider<a class="headerlink" href="#rider" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Rider</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">pickup_location</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
    <span class="n">dropoff_location</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
    <span class="n">pickup_map_node_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">dropoff_map_node_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Instantiate a rider object</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id : A unique id for each rider</span>
<span class="sd">        pickup_location: pickup lat and long</span>
<span class="sd">        dropoff_location: dropoff lat and long</span>
<span class="sd">        pickup_map_node_id: osmid of the nearest node to pickup_location</span>
<span class="sd">        dropoff_map_node_id: osmid of the nearest node to dropoff_location</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickup_location</span> <span class="o">=</span> <span class="n">pickup_location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropoff_location</span> <span class="o">=</span> <span class="n">dropoff_location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickup_map_node_id</span> <span class="o">=</span> <span class="n">pickup_map_node_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropoff_map_node_id</span> <span class="o">=</span> <span class="n">dropoff_map_node_id</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;ID of rider: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s2">&quot;Pickup location of rider: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickup_location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickup_location</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
               <span class="s2">&quot;Dropoff location of rider: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropoff_location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropoff_location</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
               <span class="s2">&quot;Pickup node id of rider: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pickup_map_node_id</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s2">&quot;Dropoff node id of rider: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropoff_map_node_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="driver">
<h3>Driver<a class="headerlink" href="#driver" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Driver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="nb">id</span><span class="p">,</span>
    <span class="n">initial_location</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
    <span class="n">initial_map_node_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate a drive object</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id : A unique id for each driver</span>
<span class="sd">        initial_location: initial lat and long</span>
<span class="sd">        initial_map_node_id: osmid of the nearest node to initial driver location</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_location</span> <span class="o">=</span> <span class="n">initial_location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_map_node_id</span> <span class="o">=</span> <span class="n">initial_map_node_id</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;ID of driver: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> \
               <span class="s2">&quot;Initial location of driver: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_location</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> \
               <span class="s2">&quot;Initial node id of driver: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_map_node_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="coord-node">
<h3>Coord (Node)<a class="headerlink" href="#coord-node" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Coord</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">osmid</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat</span>   <span class="o">=</span> <span class="n">lat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lng</span>   <span class="o">=</span> <span class="n">lng</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">osmid</span> <span class="o">=</span> <span class="n">osmid</span>
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;[lat,lng,id]=[</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">osmid</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Coord</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">osmid</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">osmid</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-sampler">
<h3>Data Sampler<a class="headerlink" href="#data-sampler" title="Permalink to this heading">#</a></h3>
<p>This class processes raw data and converts into a usable format.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Sampler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert raw data to custom data format</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : dataframe object of raw data</span>
<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        dataframe object of custom data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="c1"># Pick midpoint of all coordinates as the center of the graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dropoff_lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dropoff_lng&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

        <span class="c1"># Calculate radius as distance of farthest coordinate from midpoint</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="p">[</span><span class="n">osmnx</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">great_circle_vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dropoff_lat&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dropoff_lng&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
        <span class="c1"># self.radius = 2000</span>

        <span class="c1"># Generate graph (takes a long time)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">osmnx</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph_from_point</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">clean_periphery</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">simplify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Project graph</span>
        <span class="c1">#graph = osmnx.project_graph(graph, to_crs={&#39;init&#39;: &#39;epsg:32617&#39;})</span>

        <span class="c1"># Extract coord info</span>
        <span class="n">lats</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lngs</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="n">osmids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">lat</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dropoff_lat&#39;</span><span class="p">]</span>
            <span class="n">lng</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dropoff_lng&#39;</span><span class="p">]</span>
            <span class="n">osmid</span> <span class="o">=</span> <span class="n">osmnx</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">nearest_nodes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
            <span class="n">lats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
            <span class="n">lngs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
            <span class="n">osmids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">osmid</span><span class="p">)</span>

        <span class="c1"># Create dataframe</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">lngs</span><span class="p">,</span> <span class="n">osmids</span><span class="p">)),</span>
                              <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lng&#39;</span><span class="p">,</span><span class="s1">&#39;osmid&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">init_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize Sampler class attributes with prepared data</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : dataframe object of prepared data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="c1"># Pick midpoint of all coordinates as the center of the graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lng&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

        <span class="c1"># Calculate radius as distance of farthest coordinate from midpoint</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="p">[</span><span class="n">osmnx</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">great_circle_vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;lng&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>

        <span class="c1"># Extract coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">Coord</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;lng&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>

        <span class="c1"># Debug info</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Num coords = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)))</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">unique_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">osmid</span><span class="p">)</span> <span class="ow">or</span> <span class="n">coord</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="k">if</span> <span class="n">coord</span><span class="o">.</span><span class="n">osmid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Num coords with unique node id = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_ids</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">get_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_drivers</span><span class="p">,</span> <span class="n">n_riders</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">midpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return sample data containing drivers, riders, and graph</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_drivers   : number of drivers</span>
<span class="sd">        n_riders    : number of riders</span>
<span class="sd">        radius      : radius in metres</span>
<span class="sd">        midpoint    : midpoint as a tuple of (lat, lng)</span>
<span class="sd">        return_graph: generate a graph based on midpoint and radius</span>
<span class="sd">        Returns</span>
<span class="sd">        ---------</span>
<span class="sd">        drivers     : list of Driver objects</span>
<span class="sd">        riders      : list of Rider objects</span>
<span class="sd">        graph       : (optional) if return_graph=True, returns graph of nodes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">n_drivers</span> <span class="o">&lt;</span> <span class="n">n_riders</span>
        <span class="n">midpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">midpoint</span> <span class="k">if</span> <span class="n">midpoint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">midpoint</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="k">if</span> <span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">radius</span>

        <span class="c1"># Find valid coords within this radius</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">osmnx</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">great_circle_vec</span><span class="p">(</span><span class="n">midpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">midpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coord</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">lng</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="p">:</span>
                <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">n_drivers</span> <span class="o">+</span> <span class="n">n_riders</span> <span class="o">*</span> \
            <span class="mi">2</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">),</span> <span class="s2">&quot;Error: n_drivers=</span><span class="si">{}</span><span class="s2"> + n_riders*2=</span><span class="si">{}</span><span class="s2"> &gt; available_coords=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">n_drivers</span><span class="p">,</span> <span class="n">n_riders</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">))</span>

        <span class="c1"># Shuffle the coords for some randomization</span>
        <span class="c1"># commented for debugging purposes</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

        <span class="c1"># Assign drivers</span>
        <span class="n">drivers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_drivers</span><span class="p">:</span>
                <span class="n">drivers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Driver</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">coord</span><span class="o">.</span><span class="n">lng</span><span class="p">),</span> <span class="n">coord</span><span class="o">.</span><span class="n">osmid</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Delete the drivers</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">break</span>

        <span class="c1"># Delete any excess coords we don&#39;t need</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">n_riders</span><span class="p">]</span>

        <span class="c1"># Assign riders</span>
        <span class="n">riders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
            <span class="n">pickup</span> <span class="o">=</span> <span class="n">coord</span>
            <span class="n">dropoff</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
            <span class="n">riders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Rider</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">pickup</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">pickup</span><span class="o">.</span><span class="n">lng</span><span class="p">),</span>
                          <span class="p">(</span><span class="n">dropoff</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">dropoff</span><span class="o">.</span><span class="n">lng</span><span class="p">),</span> <span class="n">pickup</span><span class="o">.</span><span class="n">osmid</span><span class="p">,</span> <span class="n">dropoff</span><span class="o">.</span><span class="n">osmid</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">return_graph</span><span class="p">:</span>
            <span class="c1"># Generate graph for this custom radius</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="n">osmnx</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">graph_from_point</span><span class="p">(</span>
                <span class="n">midpoint</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">clean_periphery</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">simplify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span>

        <span class="k">return</span> <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">()</span>

<span class="c1"># Data preparation takes a long time.</span>
<span class="c1"># Run just once and save to a CSV, then in subsequent runs</span>
<span class="c1"># just use the saved CSV.</span>

<span class="c1"># Load in the data</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;PreparedData.csv&#39;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">sampler</span><span class="o">.</span><span class="n">init_data</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data init time = </span><span class="si">{}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Num coords = 169
Num coords with unique node id = 168
Data init time = 0.016378164291381836 seconds
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">radius</span> <span class="o">=</span> <span class="mi">6000</span>
<span class="n">num_drivers</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">num_riders</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">dt_midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="mf">43.653225</span><span class="p">,</span> <span class="o">-</span><span class="mf">79.383186</span><span class="p">)</span>
<span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_samples</span><span class="p">(</span>
    <span class="n">num_drivers</span><span class="p">,</span> <span class="n">num_riders</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">midpoint</span><span class="o">=</span><span class="n">dt_midpoint</span><span class="p">,</span> <span class="n">return_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Samples time = </span><span class="si">{}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Samples contains the following:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">drivers</span><span class="p">)</span><span class="si">}</span><span class="s1"> drivers&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">riders</span><span class="p">)</span><span class="si">}</span><span class="s1"> riders&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span><span class="si">}</span><span class="s1"> graph nodes&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Samples time = 25.41386079788208 seconds
Samples contains the following:
3 drivers
7 riders
48273 graph nodes
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot">
<h3>Plot<a class="headerlink" href="#plot" title="Permalink to this heading">#</a></h3>
<p>Used to visualize coordinates on a map.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Plot</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initializes a plot object</span>
<span class="sd">        Args:</span>
<span class="sd">            drivers (list): drivers available</span>
<span class="sd">            riders (list): riders requesting service</span>
<span class="sd">            graph (networkx.classes.multidigraph.MultiDiGraph): road network</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drivers</span> <span class="o">=</span> <span class="n">drivers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">riders</span> <span class="o">=</span> <span class="n">riders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">calc_centroid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculates centroid of points to plot</span>
<span class="sd">        Returns:</span>
<span class="sd">            list: latitude and longitude values of the centroid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">avg_lat</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">avg_lon</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_coords</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drivers</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riders</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">driver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drivers</span><span class="p">:</span>
            <span class="n">driver_ini_lat</span><span class="p">,</span> <span class="n">driver_ini_lon</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">initial_location</span>
            <span class="n">avg_lat</span> <span class="o">+=</span> <span class="n">driver_ini_lat</span>
            <span class="n">avg_lon</span> <span class="o">+=</span> <span class="n">driver_ini_lon</span>

        <span class="k">for</span> <span class="n">rider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">riders</span><span class="p">:</span>
            <span class="n">rider_pic_lat</span><span class="p">,</span> <span class="n">rider_pic_lon</span> <span class="o">=</span> <span class="n">rider</span><span class="o">.</span><span class="n">pickup_location</span>
            <span class="n">rider_dro_lat</span><span class="p">,</span> <span class="n">rider_dro_lon</span> <span class="o">=</span> <span class="n">rider</span><span class="o">.</span><span class="n">dropoff_location</span>
            <span class="n">avg_lat</span> <span class="o">+=</span> <span class="n">rider_pic_lat</span> <span class="o">+</span> <span class="n">rider_dro_lat</span>
            <span class="n">avg_lon</span> <span class="o">+=</span> <span class="n">rider_pic_lon</span> <span class="o">+</span> <span class="n">rider_dro_lon</span>

        <span class="n">avg_lat</span> <span class="o">/=</span> <span class="n">total_coords</span>
        <span class="n">avg_lon</span> <span class="o">/=</span> <span class="n">total_coords</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">avg_lat</span><span class="p">,</span> <span class="n">avg_lon</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">init_basemap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; initializes a folium basemap centered over drivers and riders</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_centroid</span><span class="p">(),</span> <span class="n">zoom_start</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_pins_to_basemap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; adds locations to basemap</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># checks that a basemap is initialized</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;must initialize basemap before adding locations&quot;</span>
        <span class="k">for</span> <span class="n">driver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drivers</span><span class="p">:</span>
            <span class="n">folium</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">initial_location</span><span class="p">),</span>
                          <span class="n">popup</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;driver </span><span class="si">{</span><span class="n">driver</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="n">icon</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">Icon</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
                          <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">riders</span><span class="p">:</span>
            <span class="n">folium</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rider</span><span class="o">.</span><span class="n">pickup_location</span><span class="p">),</span>
                          <span class="n">popup</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;rider </span><span class="si">{</span><span class="n">rider</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">: pickup&#39;</span><span class="p">,</span>
                          <span class="n">icon</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">Icon</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
                          <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>
            <span class="n">folium</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rider</span><span class="o">.</span><span class="n">dropoff_location</span><span class="p">),</span>
                          <span class="n">popup</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;rider </span><span class="si">{</span><span class="n">rider</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">: dropoff&#39;</span><span class="p">,</span>
                          <span class="n">icon</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">Icon</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                          <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">basemap_to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; exports the basemap with pins to html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># checks that a basemap is initialized</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;must initialize basemap before saving&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;basemap_with_pins.html&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_graph_with_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; plots the graph with nodes classified in colors</span>
<span class="sd">        Args:</span>
<span class="sd">            graph</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">colors_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_colors_dict</span><span class="p">()</span>
        <span class="n">all_nodes_colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nodes_colors</span><span class="p">(</span><span class="n">colors_dict</span><span class="p">)</span>

        <span class="n">all_nodes_size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span> <span class="k">if</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="n">colors_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mi">2</span>
                          <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">osmnx</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="n">all_nodes_size</span><span class="p">,</span>
            <span class="n">node_color</span><span class="o">=</span><span class="n">all_nodes_colors</span><span class="p">,</span> <span class="n">node_zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">bgcolor</span><span class="o">=</span><span class="s1">&#39;#F2F3F5&#39;</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;#B3B5B7&#39;</span><span class="p">,</span>
            <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="s1">&#39;graph_and_nodes.png&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_colors_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; generates a dictionary mapping node ids to colors</span>
<span class="sd">        Returns:</span>
<span class="sd">            colors_dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c_orange</span> <span class="o">=</span> <span class="s1">&#39;#FF8A33&#39;</span>  <span class="c1"># drivers</span>
        <span class="n">c_blue</span> <span class="o">=</span> <span class="s1">&#39;#3AACE5&#39;</span>  <span class="c1"># rider pickup</span>
        <span class="n">c_red</span> <span class="o">=</span> <span class="s1">&#39;#FF3352&#39;</span>  <span class="c1"># rider drop off</span>

        <span class="n">colors_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">driver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drivers</span><span class="p">:</span>
            <span class="n">colors_dict</span><span class="p">[</span><span class="n">driver</span><span class="o">.</span><span class="n">initial_map_node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_orange</span>

        <span class="k">for</span> <span class="n">rider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">riders</span><span class="p">:</span>
            <span class="n">colors_dict</span><span class="p">[</span><span class="n">rider</span><span class="o">.</span><span class="n">pickup_map_node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_blue</span>
            <span class="n">colors_dict</span><span class="p">[</span><span class="n">rider</span><span class="o">.</span><span class="n">dropoff_map_node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_red</span>

        <span class="k">return</span> <span class="n">colors_dict</span>

    <span class="k">def</span> <span class="nf">get_nodes_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colors_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; generates a list with color for each node id in graph</span>
<span class="sd">        Args:</span>
<span class="sd">            colors_dict</span>
<span class="sd">        Returns:</span>
<span class="sd">            all_nodes_colors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c_grey</span> <span class="o">=</span> <span class="s1">&#39;#B3B5B7&#39;</span>
        <span class="n">all_nodes_colors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">all_nodes_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colors_dict</span><span class="p">[</span><span class="n">node_id</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">all_nodes_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_grey</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_nodes_colors</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="problem-formulation">
<h2>Problem Formulation<a class="headerlink" href="#problem-formulation" title="Permalink to this heading">#</a></h2>
</section>
<section id="formulation">
<h2>Formulation<a class="headerlink" href="#formulation" title="Permalink to this heading">#</a></h2>
<p>The evaluation function is a multi-objective cost function and includes:</p>
<ol class="arabic simple">
<li><p>Minimizing deadheading by searching for solutions that reduce miles driven without passengers,</p></li>
<li><p>Maximizing fairness between independent drivers by encouraging solutions that minimize the standard deviation of the ratio between miles driven with a passenger over miles driven without a passenger</p></li>
<li><p>Maximizing fairness between wait-time of customers by minimizing the standard deviation of customer’s wait time</p></li>
<li><p>Maximizing profit by serving higher priority customers before lower priority customers.</p></li>
</ol>
<p>The following is the multi-objective function that we wish to minimize:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
    f =&amp; \underbrace{\alpha_{dh}\sum_{j=1}^{|D|} \left(\sum_{i=1}^{|d_{j}|-1} dis(c_{i, dr}, c_{i+1, cl})) \right) + dis(d_{j,0}, c_{1, cl})}_{\text{Deadheading cost}}+ \\
       &amp; \underbrace{\alpha_{d}\sqrt{\frac{\sum_{j=1}^{|D|} \left(\frac{Pr_j}{Dh_j} - \mu_{pd}\right)^2}{|D|}}}_{\text{Driver fairness}} +  \underbrace{\alpha_c\sqrt{\frac{ \sum_{i=1}^{|C|} \left(ds_i - \mu_{ds}\right)^2}{|C|}}}_{\text{Customer fairness}} -  \\
       &amp;\underbrace{\alpha_p\sum_{j=1}^{|D|} \sum_{i=1}^{|d_{j}|} \frac{dis(c_{i, cl}, c_{i, dr}) * p_i}{ds_i}}_{\text{Priority}} 
\end{align*}\end{split}\]</div>
<p>Subject to:</p>
<div class="math notranslate nohighlight">
\[
     \alpha_{dh} + \alpha_d + \alpha_c + \alpha_p = 1
\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
    \sum_{\substack{j=1 \\ c_i \in d_j}}^{|D|} 1 = 1 \quad \forall c_i
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[
    \sum_{\substack{j=1}}^{|D|} |d_j| = |C|
\]</div>
<div class="math notranslate nohighlight">
\[
    ts_i \leq  T_{max} \quad \forall c_i
\]</div>
<p>The first constraint shown in eq.2, ensures that the weights of each objective sums up to one. In eq.3 we ensure that every customer is assigned to only one driver and therefore also guarantees that all customers are matched, while in eq.4, we ensure that all customers are matched only once (i.e., no customer is matched to the same driver twice). Finally, the last constraint shown in eq.5 ensures that the wait time for any customer has to be less than or equal <span class="math notranslate nohighlight">\(T_{max}\)</span> otherwise the solution would not be feasible.</p>
<p>The design variable in this problem is the list of lists defining the order of assignments of customers to drivers and is denoted by <span class="math notranslate nohighlight">\(D\)</span>.</p>
<p>Variables:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(C\)</span>: List of customers to be served.</p></li>
<li><p><span class="math notranslate nohighlight">\(c_i\)</span>: A unique ID assigned each customer</p></li>
<li><p><span class="math notranslate nohighlight">\(c_{i, cl}\)</span>: 2D collection point of the <span class="math notranslate nohighlight">\(i^{th}\)</span> customer.</p></li>
<li><p><span class="math notranslate nohighlight">\(c_{i, dr}\)</span>: 2D drop-off point of the <span class="math notranslate nohighlight">\(i^{th}\)</span> customer.</p></li>
<li><p><span class="math notranslate nohighlight">\(t(i, j)\)</span>: Drive time of the shortest path between node <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(dis(i, j)\)</span>: Distance of the shortest path between node <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(d_{j, 0}\)</span>: Node representing the initial 2D location of <span class="math notranslate nohighlight">\(j^{th}\)</span> driver.</p></li>
<li><p><span class="math notranslate nohighlight">\(D\)</span>: List of assignments for participating drivers. Each element of the list is a list of customers assigned to a driver.</p></li>
<li><p><span class="math notranslate nohighlight">\(d_j\)</span>: Ordered list of customers assigned to <span class="math notranslate nohighlight">\(j_{th}\)</span> driver. Order defines the sequence of service.</p></li>
<li><p><span class="math notranslate nohighlight">\(Pr_j\)</span>: Total profitable miles driven by <span class="math notranslate nohighlight">\(j^{th}\)</span> driver.</p></li>
<li><p><span class="math notranslate nohighlight">\(Dh_j\)</span>: Total deadheading miles driven by <span class="math notranslate nohighlight">\(j^{th}\)</span> driver.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mu_{pd}\)</span>: Mean ratio between <span class="math notranslate nohighlight">\(Pr_j\)</span> and <span class="math notranslate nohighlight">\(Dh_j\)</span> of all drivers for a given solution.</p></li>
<li><p><span class="math notranslate nohighlight">\(ds_i\)</span>: Distance travelled before serving <span class="math notranslate nohighlight">\(i^{th}\)</span> customer.</p></li>
<li><p><span class="math notranslate nohighlight">\(ts_i\)</span>: Time taken before serving <span class="math notranslate nohighlight">\(i^{th}\)</span> customer.</p></li>
<li><p><span class="math notranslate nohighlight">\(\mu_{{ds}}\)</span>: Mean of distance travelled before serving any customer for a given solution.</p></li>
<li><p><span class="math notranslate nohighlight">\(T_{max}\)</span>: Maximum wait time for any customer.</p></li>
</ul>
</section>
<section id="solution-class">
<h2>Solution Class<a class="headerlink" href="#solution-class" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DeadHeadingProblemEvaluation</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Evaluate feasiblity and Cost of a solution to the Deadheading Problem.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">graph</span><span class="p">,</span>
        <span class="n">drivers</span><span class="p">,</span>
        <span class="n">riders</span><span class="p">,</span>
        <span class="n">alpha_deadheading</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">alpha_driver_fairness</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">alpha_rider_fairness</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize with problem parameters and do some precomputation.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        graph: map consists of nodes (used to compute shortest path)</span>
<span class="sd">        drivers : A list of driver objects</span>
<span class="sd">        riders : A list of rider objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drivers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">drivers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">riders</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">riders</span><span class="p">)</span>

        <span class="c1"># weights for cost function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_deadheading</span> <span class="o">=</span> <span class="n">alpha_deadheading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_driver_fairness</span> <span class="o">=</span> <span class="n">alpha_driver_fairness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_rider_fairness</span> <span class="o">=</span> <span class="n">alpha_rider_fairness</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_deadheading</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_driver_fairness</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_rider_fairness</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="c1"># Generate dist_matrix that is indexed by (from_osmid, to_osmid) and returns distance</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dist_matrix</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">add_dist</span><span class="p">(</span><span class="n">from_id</span><span class="p">,</span> <span class="n">to_id</span><span class="p">):</span>
            <span class="n">from_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span> <span class="n">osmid</span><span class="o">=</span><span class="n">from_id</span><span class="p">)</span>
            <span class="n">to_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span> <span class="n">osmid</span><span class="o">=</span><span class="n">to_id</span><span class="p">)</span>
            <span class="n">shortest_route</span> <span class="o">=</span> <span class="n">astar</span><span class="p">(</span>
                <span class="n">G</span><span class="o">=</span><span class="n">graph</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">from_node</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="n">to_node</span><span class="p">)</span>
            <span class="n">cost_route</span> <span class="o">=</span> <span class="n">cost</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">shortest_route</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dist_matrix</span><span class="p">[(</span><span class="n">from_id</span><span class="p">,</span> <span class="n">to_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cost_route</span>

        <span class="c1"># driver initial -&gt; rider pickup</span>
        <span class="k">for</span> <span class="n">driver</span> <span class="ow">in</span> <span class="n">drivers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rider</span> <span class="ow">in</span> <span class="n">riders</span><span class="p">:</span>
                <span class="n">add_dist</span><span class="p">(</span><span class="n">driver</span><span class="o">.</span><span class="n">initial_map_node_id</span><span class="p">,</span> <span class="n">rider</span><span class="o">.</span><span class="n">pickup_map_node_id</span><span class="p">)</span>
        <span class="c1"># rider dropoff -&gt; rider pickup</span>
        <span class="k">for</span> <span class="n">rider1</span> <span class="ow">in</span> <span class="n">riders</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rider2</span> <span class="ow">in</span> <span class="n">riders</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rider1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">rider2</span><span class="p">:</span>
                    <span class="n">add_dist</span><span class="p">(</span><span class="n">rider1</span><span class="o">.</span><span class="n">dropoff_map_node_id</span><span class="p">,</span>
                             <span class="n">rider2</span><span class="o">.</span><span class="n">pickup_map_node_id</span><span class="p">)</span>
        <span class="c1"># rider pickup -&gt; dropoff</span>
        <span class="k">for</span> <span class="n">rider</span> <span class="ow">in</span> <span class="n">riders</span><span class="p">:</span>
            <span class="n">add_dist</span><span class="p">(</span><span class="n">rider</span><span class="o">.</span><span class="n">pickup_map_node_id</span><span class="p">,</span> <span class="n">rider</span><span class="o">.</span><span class="n">dropoff_map_node_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add solution to evaluate, and do some precomputation.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        solution: A list of lists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">solution</span>
        <span class="c1"># constraints</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drivers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_assignment_constraint</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match_all_riders_constraint</span><span class="p">()</span>
        <span class="c1"># compute distances once to speed up evaluation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deadheading_miles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profitable_mile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prearrival_miles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_driver_deadhead_profit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">evaluate_cost_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_deadheading</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_deadheading_cost</span><span class="p">()</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">alpha_driver_fairness</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_driver_fairness</span><span class="p">()</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">alpha_rider_fairness</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_rider_fairness</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">evaluate_deadheading_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deadheading_miles</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate_driver_fairness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">delta_pr_dh</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">pr</span><span class="o">-</span><span class="n">dh</span><span class="p">)</span> <span class="k">for</span> <span class="n">dh</span><span class="p">,</span>
                       <span class="n">pr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deadheading_miles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">profitable_mile</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">statistics</span><span class="o">.</span><span class="n">stdev</span><span class="p">(</span><span class="n">delta_pr_dh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">evaluate_rider_fairness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Flatten prearrival times into a 1D list</span>
        <span class="n">all_prearrival_miles</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prearrival_miles</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="n">statistics</span><span class="o">.</span><span class="n">stdev</span><span class="p">(</span><span class="n">all_prearrival_miles</span><span class="p">)</span>

    <span class="c1"># return deadhing miles and profitable miles for each driver</span>
    <span class="k">def</span> <span class="nf">get_driver_deadhead_profit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">deadheading_miles</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># deadheading miles for each driver</span>
        <span class="n">profitable_miles</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># profitable miles for each driver</span>
        <span class="n">prearrival_miles</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># same format as solution, represents driver miles travelled before reaching this rider</span>
        <span class="c1"># loop over drivers</span>
        <span class="k">for</span> <span class="n">driver_idx</span><span class="p">,</span> <span class="n">riders</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">):</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drivers</span><span class="p">[</span><span class="n">driver_idx</span><span class="p">]</span>
            <span class="n">dh_miles</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pr_miles</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pa_miles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># loop over riders of current driver</span>
            <span class="k">for</span> <span class="n">rider_idx</span><span class="p">,</span> <span class="n">rider</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">riders</span><span class="p">):</span>
                <span class="c1"># deadheading</span>
                <span class="k">if</span> <span class="n">rider_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dh_miles</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">osmid_a</span><span class="o">=</span><span class="n">driver</span><span class="o">.</span><span class="n">initial_map_node_id</span><span class="p">,</span>
                                          <span class="n">osmid_b</span><span class="o">=</span><span class="n">rider</span><span class="o">.</span><span class="n">pickup_map_node_id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prev_rider</span> <span class="o">=</span> <span class="n">riders</span><span class="p">[</span><span class="n">rider_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">dh_miles</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">osmid_a</span><span class="o">=</span><span class="n">prev_rider</span><span class="o">.</span><span class="n">dropoff_map_node_id</span><span class="p">,</span>
                                          <span class="n">osmid_b</span><span class="o">=</span><span class="n">rider</span><span class="o">.</span><span class="n">pickup_map_node_id</span><span class="p">)</span>
                <span class="c1"># prearrival</span>
                <span class="n">pa_miles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pr_miles</span> <span class="o">+</span> <span class="n">dh_miles</span><span class="p">)</span>
                <span class="c1"># profit</span>
                <span class="n">pr_miles</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">osmid_a</span><span class="o">=</span><span class="n">rider</span><span class="o">.</span><span class="n">pickup_map_node_id</span><span class="p">,</span>
                                      <span class="n">osmid_b</span><span class="o">=</span><span class="n">rider</span><span class="o">.</span><span class="n">dropoff_map_node_id</span><span class="p">)</span>
            <span class="c1"># populate total deadhing and profitable miles for current driver</span>
            <span class="n">deadheading_miles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dh_miles</span><span class="p">)</span>
            <span class="n">profitable_miles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pr_miles</span><span class="p">)</span>  
            <span class="n">prearrival_miles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pa_miles</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deadheading_miles</span><span class="p">,</span> <span class="n">profitable_miles</span><span class="p">,</span> <span class="n">prearrival_miles</span>

    <span class="k">def</span> <span class="nf">unique_assignment_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># loop over riders</span>
        <span class="k">for</span> <span class="n">rider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">riders</span><span class="p">:</span>
            <span class="c1"># loop over assiment list of each driver</span>
            <span class="n">num_of_assignments</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">driver_solution</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">:</span>
                <span class="n">current_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">rider</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">rider</span> <span class="ow">in</span> <span class="n">driver_solution</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">rider</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">current_ids</span><span class="p">:</span>
                    <span class="n">num_of_assignments</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">num_of_assignments</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Error: Number of assignments for Rider: </span><span class="si">{}</span><span class="s2"> is </span><span class="si">{}</span><span class="s2">, Expected assignment </span><span class="se">\</span>
<span class="s2">            is 1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rider</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">num_of_assignments</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">match_all_riders_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">number_of_assignments</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">driver_assigment</span><span class="p">)</span> <span class="k">for</span> <span class="n">driver_assigment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">number_of_assignments</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">riders</span><span class="p">),</span> <span class="s2">&quot;Number of assigned riders greater than number of riders!&quot;</span>

    <span class="c1"># Compute shortest path between two nodes on a graph</span>
    <span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">osmid_a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">osmid_b</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_matrix</span><span class="p">[(</span><span class="n">osmid_a</span><span class="p">,</span> <span class="n">osmid_b</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">eval_obj</span> <span class="o">=</span> <span class="n">DeadHeadingProblemEvaluation</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Eval init time = </span><span class="si">{}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Eval init time = 12.58279013633728 seconds
</pre></div>
</div>
</div>
</div>
</section>
<section id="solution-1-simulated-annealing">
<h2>Solution 1: Simulated Annealing<a class="headerlink" href="#solution-1-simulated-annealing" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RandomSolution</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drivers</span> <span class="o">=</span> <span class="n">drivers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">riders</span> <span class="o">=</span> <span class="n">riders</span>

        <span class="c1"># setting random seed from config file</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;config.ini&#39;</span><span class="p">)</span>
        <span class="c1">#random.seed(config.get(&#39;main&#39;, &#39;seed&#39;))</span>

    <span class="k">def</span> <span class="nf">get_random_sol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># init random solution</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># add empty list for each driver</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drivers</span><span class="p">)):</span>
            <span class="n">rs</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="c1"># add each rider to one driver</span>
        <span class="k">for</span> <span class="n">rider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">riders</span><span class="p">:</span>
            <span class="c1"># random index within drivers list</span>
            <span class="n">r_idx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drivers</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rs</span><span class="p">[</span><span class="n">r_idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rider</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rs</span>


<span class="k">class</span> <span class="nc">NeighborSolutions</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">set_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">get_neigbors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;Must set solution first&#39;</span>
        <span class="c1"># driver swap</span>
        <span class="n">ds_sol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver_swap</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
        <span class="c1"># rider reassign</span>
        <span class="n">rr_sol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rider_reassign</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
        <span class="c1"># rider shuffle</span>
        <span class="n">rs_sol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rider_shuffle</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">ds_sol</span><span class="p">,</span> <span class="n">rr_sol</span><span class="p">,</span> <span class="n">rs_sol</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_or_sol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; gets original variable &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">or_sol</span>

    <span class="k">def</span> <span class="nf">get_ds_sol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; gets driver swap &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds_sol</span>

    <span class="k">def</span> <span class="nf">get_rr_sol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; gets rider reassign &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rr_sol</span>

    <span class="k">def</span> <span class="nf">get_rs_sol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; gets rider shuffle &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rs_sol</span>

    <span class="k">def</span> <span class="nf">driver_swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; swaps all riders  between two drivers</span>

<span class="sd">        Args:</span>
<span class="sd">            s (list): original solution</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: new solution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_drivers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">idx_swap</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_drivers</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">temp_data</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">idx_swap</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">s</span><span class="p">[</span><span class="n">idx_swap</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">idx_swap</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">s</span><span class="p">[</span><span class="n">idx_swap</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">temp_data</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">rider_reassign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; reassigns one rider to another driver]</span>

<span class="sd">        Args:</span>
<span class="sd">            s (list): original solution</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: new solution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_drivers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># a driver giving one rider</span>
            <span class="n">d_giving</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_drivers</span><span class="p">),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># checks the giving driver has at least one rider</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">d_giving</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">r_available</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">d_giving</span><span class="p">])</span>  <span class="c1"># available number of riders</span>
        <span class="c1"># index of moving rider</span>
        <span class="n">idx_moving</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">r_available</span><span class="p">),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">r_moving</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">d_giving</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx_moving</span><span class="p">)</span>  <span class="c1"># rider moving</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">d_receiving</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_drivers</span><span class="p">),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># checks receiving driver is not giving driver</span>
            <span class="k">if</span> <span class="n">d_giving</span> <span class="o">!=</span> <span class="n">d_receiving</span><span class="p">:</span>
                <span class="n">c_riders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">d_receiving</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">c_riders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">idx_moving</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">c_riders</span><span class="p">),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">d_receiving</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">idx_moving</span><span class="p">,</span> <span class="n">r_moving</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">d_receiving</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_moving</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">rider_shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; shuffles riders of one driver</span>

<span class="sd">        Args:</span>
<span class="sd">            s (list): original solution</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: new solution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_drivers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># driver shuffling its riders</span>
            <span class="n">d_shuffling</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_drivers</span><span class="p">),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">d_shuffling</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">d_shuffling</span><span class="p">])</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">get_SA_parameters</span><span class="p">(</span><span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">eval_obj</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">adaptive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; function that determines proper parameters for the SA method</span>

<span class="sd">    Args:</span>
<span class="sd">        drivers ([type]): [description]</span>
<span class="sd">        riders ([type]): [description]</span>
<span class="sd">        eval_obj ([type]): [description]</span>
<span class="sd">        iterations ([type]): [description]</span>

<span class="sd">    Returns:</span>
<span class="sd">        [type]: [description]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># number of random samples to get statistics from</span>
    <span class="n">num_samples</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="c1"># store cost of sample solutions</span>
    <span class="n">sample_sol_c</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
        <span class="c1"># random solution</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">RandomSolution</span><span class="p">(</span>
            <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">)</span><span class="o">.</span><span class="n">get_random_sol</span><span class="p">())</span>
        <span class="n">eval_obj</span><span class="o">.</span><span class="n">set_solution</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c1"># cost of random solution</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">eval_obj</span><span class="o">.</span><span class="n">evaluate_cost_func</span><span class="p">()</span>
        <span class="n">sample_sol_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c1"># average and standard deviation of cost</span>
    <span class="n">avg_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sample_sol_c</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sample_sol_c</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="c1"># setting initial temperature as</span>
    <span class="c1"># 3.5 or 1.0 of the std of the cost of 100 random solutions</span>
    <span class="k">if</span> <span class="n">adaptive</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mf">3.5</span> <span class="o">*</span> <span class="n">std_c</span>  <span class="c1"># encourage more exploration in adaptive version</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">std_c</span>
    <span class="c1"># final temperature is set to 0.1 std of cost</span>
    <span class="n">t_final</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">std_c</span>
    <span class="c1"># extracting lambda from temperature equation</span>
    <span class="n">lam</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t_final</span><span class="o">/</span><span class="n">k</span><span class="p">))</span> <span class="o">/</span> <span class="n">iterations</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">runSA</span><span class="p">(</span><span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">eval_obj</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">adaptive</span><span class="p">):</span>
    <span class="n">hist_solutions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hist_costs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sa_solver</span> <span class="o">=</span> <span class="n">SAnnealingSolver</span><span class="p">(</span>
        <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">eval_obj</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">adaptive</span><span class="p">)</span>
    <span class="n">solution_i</span><span class="p">,</span> <span class="n">cost_i</span> <span class="o">=</span> <span class="n">sa_solver</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
    <span class="n">hist_solutions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solution_i</span><span class="p">)</span>
    <span class="n">hist_costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_i</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">)):</span>
        <span class="n">sa_solver</span><span class="o">.</span><span class="n">obtain_neighbors</span><span class="p">()</span>
        <span class="n">sa_solver</span><span class="o">.</span><span class="n">pick_solution</span><span class="p">()</span>
        <span class="n">sa_solver</span><span class="o">.</span><span class="n">determine_next_solution</span><span class="p">()</span>
        <span class="n">solution_i</span><span class="p">,</span> <span class="n">cost_i</span> <span class="o">=</span> <span class="n">sa_solver</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
        <span class="n">hist_solutions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solution_i</span><span class="p">)</span>
        <span class="n">hist_costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hist_solutions</span><span class="p">,</span> <span class="n">hist_costs</span>


<span class="k">def</span> <span class="nf">print_SA_states</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Solution </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> cost -&gt; </span><span class="si">{</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">print_best</span><span class="p">(</span><span class="n">hist_costs</span><span class="p">):</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hist_costs</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Best solution cost -&gt; </span><span class="si">{</span><span class="n">best</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="solver-class">
<h3>Solver Class<a class="headerlink" href="#solver-class" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SAnnealingSolver</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">eval_obj</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">adaptive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># problem setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drivers</span> <span class="o">=</span> <span class="n">drivers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">riders</span> <span class="o">=</span> <span class="n">riders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># parameters of temperature schedule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_schedule</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
        <span class="c1"># simulated annealing variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_s</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">RandomSolution</span><span class="p">(</span>
            <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">)</span><span class="o">.</span><span class="n">get_random_sol</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_s</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_obj</span> <span class="o">=</span> <span class="n">eval_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_current_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ns_generator</span> <span class="o">=</span> <span class="n">NeighborSolutions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive</span> <span class="o">=</span> <span class="n">adaptive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_seen</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_s</span><span class="p">)</span>

    <span class="c1"># from https://smartmobilityalgorithms.github.io/book/content/TrajectoryAlgorithms/SimulatedAnnealing.html</span>
    <span class="k">def</span> <span class="nf">exp_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lam</span><span class="p">):</span>
        <span class="c1"># i corresponds to the iteration</span>
        <span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lam</span><span class="o">*</span><span class="n">i</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">function</span>

    <span class="k">def</span> <span class="nf">obtain_neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ns_generator</span><span class="o">.</span><span class="n">set_solution</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_s</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ns_generator</span><span class="o">.</span><span class="n">get_neigbors</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">pick_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ------- adaptive part -------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_seen</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best_seen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_s</span>
            <span class="n">candidate_from_neighbors</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
                <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_s</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="p">[</span><span class="n">candidate_from_neighbors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_seen</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_s</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_obj</span><span class="o">.</span><span class="n">set_solution</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_obj</span><span class="o">.</span><span class="n">evaluate_cost_func</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_T</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>

    <span class="c1"># from https://github.com/SmartMobilityAlgorithms/smart_mobility_utilities/blob/master/smart_mobility_utilities/common.py</span>
    <span class="k">def</span> <span class="nf">probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># from https://smartmobilityalgorithms.github.io/book/content/TrajectoryAlgorithms/SimulatedAnnealing.html</span>
    <span class="k">def</span> <span class="nf">determine_next_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_current_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_s</span><span class="p">)</span>
        <span class="n">cost_next_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_s</span><span class="p">)</span>
        <span class="n">delta_e</span> <span class="o">=</span> <span class="n">cost_next_s</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_current_s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_T</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">delta_e</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">probability</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">delta_e</span><span class="o">/</span><span class="n">T</span><span class="p">)):</span>
            <span class="c1">#coin = random.choice([1, 1, 1, 0, 0, 0, 0, 0])</span>
            <span class="c1"># if delta_e &lt; 0 or coin:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_s</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_current_s</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualization">
<h3>Visualization<a class="headerlink" href="#visualization" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simulated Annealing part for evaluation script</span>
<span class="n">iterations</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">k</span><span class="p">,</span> <span class="n">lam</span> <span class="o">=</span> <span class="n">get_SA_parameters</span><span class="p">(</span><span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">eval_obj</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">adaptive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">hist_solutions</span><span class="p">,</span> <span class="n">hist_costs</span> <span class="o">=</span> <span class="n">runSA</span><span class="p">(</span>
    <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">eval_obj</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">adaptive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SA time = </span><span class="si">{}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 500/500 [00:00&lt;00:00, 792.95it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SA time = 0.6326920986175537 seconds
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_costs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iterations&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cost&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Simulated Annealing&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final cost:</span><span class="si">{</span><span class="n">hist_costs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Final cost:20512.625309653413
</pre></div>
</div>
<img alt="../../../_images/8d797f820bf5eff9262cc91a8fdc00c536355cba004938fafcbe57cc3ace9c6a.png" src="../../../_images/8d797f820bf5eff9262cc91a8fdc00c536355cba004938fafcbe57cc3ace9c6a.png" />
</div>
</div>
</section>
</section>
<section id="solution-2-genetic-algorithm">
<h2>Solution 2: Genetic Algorithm<a class="headerlink" href="#solution-2-genetic-algorithm" title="Permalink to this heading">#</a></h2>
<section id="id1">
<h3>Solver Class<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GeneticSolver</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">evaluation</span><span class="p">,</span> <span class="n">pop_size</span><span class="p">,</span> <span class="n">crossover_rate</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_size</span> <span class="o">=</span> <span class="n">pop_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crossover_rate</span> <span class="o">=</span> <span class="n">crossover_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutation_rate</span> <span class="o">=</span> <span class="n">mutation_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drivers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">drivers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">riders</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">riders</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_obj</span> <span class="o">=</span> <span class="n">evaluation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize_population</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">initialize_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">population</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># generate solutions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_size</span><span class="p">):</span>
            <span class="n">sol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_solution</span><span class="p">()</span>
            <span class="n">population</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">population</span>

    <span class="k">def</span> <span class="nf">crossover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">max_num_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_size</span><span class="o">//</span><span class="mi">2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_num_children</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossover_rate</span><span class="p">:</span>
                <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="c1"># init child</span>
                <span class="n">num_drivers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drivers</span><span class="p">)</span>
                
                <span class="n">child1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">()</span> <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_drivers</span><span class="p">)]</span>
                <span class="c1"># Take permutation from P1 and driver assignment structure from P2</span>
                <span class="c1"># permutation of P1 - flatten</span>
                <span class="n">permutation_p1</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">p1</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
                <span class="c1"># Assign based on P2</span>
                <span class="n">assignments</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">driver_idx</span><span class="p">,</span> <span class="n">driver_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p2</span><span class="p">):</span>
                    <span class="n">child1</span><span class="p">[</span><span class="n">driver_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">permutation_p1</span><span class="p">[</span><span class="n">assignments</span><span class="p">:</span><span class="n">assignments</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">driver_list</span><span class="p">)]</span>
                    <span class="n">assignments</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">driver_list</span><span class="p">)</span>
                <span class="c1"># check</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">flat_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">child1</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riders</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child1</span><span class="p">)</span>

                <span class="n">child2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">()</span> <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_drivers</span><span class="p">)]</span>
                <span class="c1"># Take permutation from P2 and driver assignment structure from P1</span>
                <span class="c1"># permutation of P2 - flatten</span>
                <span class="n">permutation_p2</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">p2</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
                <span class="c1"># Assign based on P2</span>
                <span class="n">assignments</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">driver_idx</span><span class="p">,</span> <span class="n">driver_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p1</span><span class="p">):</span>
                    <span class="n">child2</span><span class="p">[</span><span class="n">driver_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">permutation_p2</span><span class="p">[</span><span class="n">assignments</span><span class="p">:</span><span class="n">assignments</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">driver_list</span><span class="p">)]</span>
                    <span class="n">assignments</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">driver_list</span><span class="p">)</span>
                <span class="c1"># check</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">flat_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">child2</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riders</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child2</span><span class="p">)</span>

    <span class="c1"># inplace switch two driver assignments</span>
    <span class="k">def</span> <span class="nf">mutate_driver_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutation_rate</span><span class="p">:</span>
                <span class="n">selected_drivers</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drivers</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">driver_a_idx</span> <span class="o">=</span> <span class="n">selected_drivers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">driver_b_idx</span> <span class="o">=</span> <span class="n">selected_drivers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">driver_a</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">driver_a_idx</span><span class="p">][:]</span>
                <span class="n">driver_b</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">driver_b_idx</span><span class="p">][:]</span>
                <span class="n">p</span><span class="p">[</span><span class="n">driver_a_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">driver_b</span>
                <span class="n">p</span><span class="p">[</span><span class="n">driver_b_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">driver_a</span>

    <span class="c1"># inplace switch two riders</span>
    <span class="k">def</span> <span class="nf">mutate_rider_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutation_rate</span><span class="p">:</span>
                <span class="n">permutations</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
                <span class="n">selected_riders</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riders</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">rider_1_idx</span> <span class="o">=</span> <span class="n">selected_riders</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">rider_2_idx</span> <span class="o">=</span> <span class="n">selected_riders</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">rider_id_1</span> <span class="o">=</span> <span class="n">permutations</span><span class="p">[</span><span class="n">rider_1_idx</span><span class="p">]</span>
                <span class="n">rider_id_2</span> <span class="o">=</span> <span class="n">permutations</span><span class="p">[</span><span class="n">rider_2_idx</span><span class="p">]</span> 
                <span class="n">mutated_permutations</span> <span class="o">=</span> <span class="n">permutations</span>
                <span class="n">mutated_permutations</span><span class="p">[</span><span class="n">rider_1_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">rider_id_2</span>
                <span class="n">mutated_permutations</span><span class="p">[</span><span class="n">rider_2_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">rider_id_1</span>
                <span class="n">assignments</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">driver_idx</span><span class="p">,</span> <span class="n">driver_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="n">p</span><span class="p">[</span><span class="n">driver_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mutated_permutations</span><span class="p">[</span><span class="n">assignments</span><span class="p">:</span><span class="n">assignments</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">driver_list</span><span class="p">)]</span>
                    <span class="n">assignments</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">driver_list</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">fitness_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
        <span class="n">cost_per_solution</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">:</span>
            <span class="n">sol_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_objects</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_obj</span><span class="o">.</span><span class="n">set_solution</span><span class="p">(</span><span class="n">sol_obj</span><span class="p">)</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_obj</span><span class="o">.</span><span class="n">evaluate_cost_func</span><span class="p">()</span>
            <span class="n">cost_per_solution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">best_score</span> <span class="o">&gt;</span> <span class="n">cost</span><span class="p">:</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">cost</span>              
        
        <span class="c1"># update best score</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">=</span> <span class="n">best_score</span>
        <span class="c1"># sorted population based on cost per solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="p">[</span><span class="n">sorted_solution</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">sorted_solution</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cost_per_solution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">))]</span>
    
    <span class="c1"># update population to be top 50% that minimize objective - Elitism</span>
    <span class="k">def</span> <span class="nf">select_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># survival of the fittest</span>
        <span class="n">num_parents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_size</span><span class="o">//</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_parents</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">index_to_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx_sol</span><span class="p">):</span>
        <span class="n">sol_obj</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">driver_assignment</span> <span class="ow">in</span> <span class="n">idx_sol</span><span class="p">:</span>
            <span class="n">driver_assignment_obj</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">rider_idx</span> <span class="ow">in</span> <span class="n">driver_assignment</span><span class="p">:</span>
                <span class="n">driver_assignment_obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riders</span><span class="p">[</span><span class="n">rider_idx</span><span class="p">])</span>
            <span class="n">sol_obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">driver_assignment_obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sol_obj</span>

    <span class="c1"># returns a list of lists of indices representing assignments for each driver</span>
    <span class="k">def</span> <span class="nf">generate_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num_riders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">riders</span><span class="p">)</span>
        <span class="n">num_drivers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drivers</span><span class="p">)</span>
        <span class="c1"># create list of empty lists</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">()</span> <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_drivers</span><span class="p">)]</span>
        <span class="c1"># generate random permutation of riders</span>
        <span class="n">riders_permutation</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_riders</span><span class="p">))</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">riders_permutation</span><span class="p">)</span>
        <span class="c1"># Getting N (drivers) random numbers whose sum is M (riders)</span>
        <span class="c1">#https://stackoverflow.com/questions/2640053/getting-n-random-numbers-whose-sum-is-m/2640079#2640079</span>
        <span class="c1"># Generate N-1 random numbers between 0 and 1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">num_drivers</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Add the numbers 0 and 1 themselves to the list and then sort them</span>
        <span class="n">x</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">x</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="c1"># Take the differences of adjacent numbers</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
        <span class="n">driver_assigment</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span> <span class="o">*</span> <span class="n">num_riders</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">]</span>
        <span class="n">sum_assignment</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">driver_assigment</span><span class="p">)</span>
        <span class="c1"># </span>
        <span class="n">num_unassigned</span> <span class="o">=</span> <span class="n">num_riders</span> <span class="o">-</span> <span class="n">sum_assignment</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_unassigned</span><span class="p">):</span>
            <span class="n">driver_idx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_drivers</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">driver_assigment</span><span class="p">[</span><span class="n">driver_idx</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span><span class="n">driver_assigment</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_riders</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">driver_assigment</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_drivers</span>
        <span class="k">for</span> <span class="n">driver_idx</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sol</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">driver_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">riders_permutation</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">driver_assigment</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">assignments_so_far</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">driver_assigment</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">driver_idx</span><span class="p">])</span>
                <span class="n">s</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">riders_permutation</span><span class="p">[</span><span class="n">assignments_so_far</span><span class="p">:</span><span class="n">assignments_so_far</span> <span class="o">+</span> <span class="n">driver_assigment</span><span class="p">[</span><span class="n">driver_idx</span><span class="p">]])</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">flat_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">sol</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
            <span class="n">flat_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">flat_list</span><span class="p">))</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_riders</span>
        <span class="k">return</span> <span class="n">sol</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_GA</span><span class="p">(</span><span class="n">evaluation_object</span><span class="p">,</span> <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">initial_pop_size</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">crossover_rate</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">adaptive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gs_solver</span> <span class="o">=</span> <span class="n">GeneticSolver</span><span class="p">(</span><span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">evaluation_object</span><span class="p">,</span> 
                             <span class="n">pop_size</span><span class="o">=</span><span class="n">initial_pop_size</span><span class="p">,</span> 
                             <span class="n">crossover_rate</span><span class="o">=</span><span class="n">crossover_rate</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="o">=</span><span class="n">mutation_rate</span><span class="p">)</span>
    <span class="n">initial_crossover_rate</span> <span class="o">=</span> <span class="n">gs_solver</span><span class="o">.</span><span class="n">crossover_rate</span>
    <span class="n">initial_mutation_rate</span> <span class="o">=</span> <span class="n">gs_solver</span><span class="o">.</span><span class="n">mutation_rate</span>
    <span class="n">final_crossover_rate</span> <span class="o">=</span> <span class="mf">0.6</span>
    <span class="n">final_mutation_rate</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="k">if</span> <span class="n">adaptive</span><span class="p">:</span> 
        <span class="k">assert</span> <span class="n">final_crossover_rate</span> <span class="o">&lt;=</span> <span class="n">crossover_rate</span>
        <span class="k">assert</span> <span class="n">final_mutation_rate</span> <span class="o">&lt;=</span> <span class="n">mutation_rate</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">)):</span>
        <span class="n">gs_solver</span><span class="o">.</span><span class="n">fitness_func</span><span class="p">()</span>
        <span class="n">gs_solver</span><span class="o">.</span><span class="n">select_parent</span><span class="p">()</span>
        <span class="n">gs_solver</span><span class="o">.</span><span class="n">crossover</span><span class="p">()</span>
        <span class="n">gs_solver</span><span class="o">.</span><span class="n">mutate_rider_sequence</span><span class="p">()</span>
        <span class="n">gs_solver</span><span class="o">.</span><span class="n">mutate_driver_assignment</span><span class="p">()</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gs_solver</span><span class="o">.</span><span class="n">best_score</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">adaptive</span><span class="p">:</span>
            <span class="n">gs_solver</span><span class="o">.</span><span class="n">crossover_rate</span> <span class="o">-=</span> <span class="p">(</span><span class="n">initial_crossover_rate</span> <span class="o">-</span> <span class="n">final_crossover_rate</span><span class="p">)</span><span class="o">/</span><span class="n">iterations</span>
            <span class="n">gs_solver</span><span class="o">.</span><span class="n">mutation_rate</span> <span class="o">-=</span> <span class="p">(</span><span class="n">initial_mutation_rate</span> <span class="o">-</span> <span class="n">final_mutation_rate</span><span class="p">)</span><span class="o">/</span><span class="n">iterations</span>
    <span class="n">gs_solver</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">scores</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">hist_costs</span> <span class="o">=</span> <span class="n">run_GA</span><span class="p">(</span><span class="n">eval_obj</span><span class="p">,</span> <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">initial_pop_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">crossover_rate</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GA time = </span><span class="si">{}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 500/500 [00:35&lt;00:00, 14.04it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GA time = 35.630380392074585 seconds
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize">
<h3>Visualize<a class="headerlink" href="#visualize" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_costs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iterations&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cost&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Genetic Algorithm&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final cost:</span><span class="si">{</span><span class="n">hist_costs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Final cost:18363.09688504041
</pre></div>
</div>
<img alt="../../../_images/74279bce4fa0a2381828eb413f665c3b255c85e6782fb4842ef48162f34536ce.png" src="../../../_images/74279bce4fa0a2381828eb413f665c3b255c85e6782fb4842ef48162f34536ce.png" />
</div>
</div>
</section>
</section>
<section id="solution-3-grey-wolf-algorithm">
<h2>Solution 3: Grey Wolf Algorithm<a class="headerlink" href="#solution-3-grey-wolf-algorithm" title="Permalink to this heading">#</a></h2>
<p>You can read more about the Grey Wolf Optimizer <a class="reference external" href="https://www.sciencedirect.com/science/article/abs/pii/S0965997813001853">here</a>.</p>
<section id="wolf-class">
<h3>Wolf Class<a class="headerlink" href="#wolf-class" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Wolf</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">eval_obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span> <span class="o">=</span> <span class="n">solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eval_obj</span> <span class="o">=</span> <span class="n">eval_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cost</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_cost</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span>

    <span class="nd">@solution</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_solution</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solution</span> <span class="o">=</span> <span class="n">new_solution</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost</span>

    <span class="nd">@cost</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_cost</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cost</span> <span class="o">=</span> <span class="n">new_cost</span>

    <span class="k">def</span> <span class="nf">update_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eval_obj</span><span class="o">.</span><span class="n">set_solution</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eval_obj</span><span class="o">.</span><span class="n">evaluate_cost_func</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">cost</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">cost</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;This wolf</span><span class="se">\&#39;</span><span class="s1">s cost is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cost</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h3>Solver Class:<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GWSolver</span><span class="p">():</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">eval_obj</span><span class="p">,</span> <span class="n">pack_size</span><span class="p">,</span> <span class="n">max_hunt_range</span><span class="p">,</span> <span class="n">iterations</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># validations</span>
        <span class="k">if</span> <span class="n">pack_size</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Pack size must be greater than 3&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_hunt_range</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Maximum hunting range must be &gt;= 1&#39;</span><span class="p">)</span>

        <span class="c1"># problem setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drivers</span> <span class="o">=</span> <span class="n">drivers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">riders</span> <span class="o">=</span> <span class="n">riders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_obj</span> <span class="o">=</span> <span class="n">eval_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="n">iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># grey wolf data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># pack_size determines the number of wolves in the pack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack_size</span> <span class="o">=</span> <span class="n">pack_size</span>
        <span class="c1"># max_hunt_range determines how many moves a wolf makes at an iteration</span>
        <span class="c1"># begins high and reduces to very few moves at the end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_hunt_range</span> <span class="o">=</span> <span class="n">max_hunt_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_hunt_range</span> <span class="o">=</span> <span class="n">max_hunt_range</span>
        <span class="c1"># attack_rate determines how many wolves attack at a given iteration</span>
        <span class="c1"># begins low and rises to all wolves attacking at the end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attack_rate</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># three leading wolves</span>
        <span class="c1"># utilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ns_generator</span> <span class="o">=</span> <span class="n">NeighborSolutions</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generate_wolves_pack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pack_size</span><span class="p">):</span>
            <span class="n">rand_sol</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">RandomSolution</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drivers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">riders</span><span class="p">)</span><span class="o">.</span><span class="n">get_random_sol</span><span class="p">())</span>
            <span class="n">a_wolf</span> <span class="o">=</span> <span class="n">Wolf</span><span class="p">(</span><span class="n">rand_sol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_obj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_wolf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">identify_lead_wolves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">update_hunting_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">iterations</span>
        <span class="n">num_moves</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">progress</span><span class="p">))</span>
                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_hunt_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_hunt_range</span> <span class="o">=</span> <span class="n">num_moves</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">update_attack_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">iterations</span>
        <span class="c1"># three leading wolves</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attack_rate</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">progress</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pack_size</span> <span class="o">-</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">pack_hunts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attack_rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack_size</span><span class="p">):</span>
            <span class="c1"># current wolf&#39;s solution</span>
            <span class="n">new_solution</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leads</span><span class="p">)</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
            <span class="n">move</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">move</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_hunt_range</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ns_generator</span><span class="o">.</span><span class="n">set_solution</span><span class="p">(</span><span class="n">new_solution</span><span class="p">)</span>
                <span class="n">new_solution</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ns_generator</span><span class="o">.</span><span class="n">get_neigbors</span><span class="p">()))</span>
                <span class="n">move</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Wolf</span><span class="p">(</span><span class="n">new_solution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">avg_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">a_wolf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">:</span>
            <span class="n">avg_cost</span> <span class="o">+=</span> <span class="n">a_wolf</span><span class="o">.</span><span class="n">cost</span>
        <span class="n">avg_cost</span> <span class="o">=</span> <span class="n">avg_cost</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pack_size</span>
        <span class="k">return</span> <span class="n">avg_cost</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">runGW</span><span class="p">(</span><span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">eval_obj</span><span class="p">,</span> <span class="n">pack_size</span><span class="p">,</span> <span class="n">max_hunt_range</span><span class="p">,</span> <span class="n">iterations</span><span class="p">):</span>
    <span class="n">hist_costs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gw_solver</span> <span class="o">=</span> <span class="n">GWSolver</span><span class="p">(</span><span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">eval_obj</span><span class="p">,</span>
                         <span class="n">pack_size</span><span class="p">,</span> <span class="n">max_hunt_range</span><span class="p">,</span> <span class="n">iterations</span><span class="p">)</span>
    <span class="n">gw_solver</span><span class="o">.</span><span class="n">generate_wolves_pack</span><span class="p">()</span>
    <span class="n">cost_i</span> <span class="o">=</span> <span class="n">gw_solver</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
    <span class="n">hist_costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_i</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">)):</span>
        <span class="n">gw_solver</span><span class="o">.</span><span class="n">identify_lead_wolves</span><span class="p">()</span>
        <span class="n">gw_solver</span><span class="o">.</span><span class="n">update_hunting_range</span><span class="p">()</span>
        <span class="n">gw_solver</span><span class="o">.</span><span class="n">update_attack_rate</span><span class="p">()</span>
        <span class="n">gw_solver</span><span class="o">.</span><span class="n">pack_hunts</span><span class="p">()</span>
        <span class="n">cost_i</span> <span class="o">=</span> <span class="n">gw_solver</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
        <span class="n">hist_costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost_i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hist_costs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Grey Wolf parameters</span>
<span class="n">iterations</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">pack_size</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">max_hunt_range</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c1"># Running GW</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">hist_costs</span> <span class="o">=</span> <span class="n">runGW</span><span class="p">(</span><span class="n">drivers</span><span class="p">,</span> <span class="n">riders</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">eval_obj</span><span class="p">,</span> <span class="n">pack_size</span><span class="p">,</span> <span class="n">max_hunt_range</span><span class="p">,</span> <span class="n">iterations</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;grey wolf time = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;grey wolf min cost </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">hist_costs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 500/500 [00:05&lt;00:00, 91.77it/s] 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>grey wolf time = 5
grey wolf min cost 17034.0
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h3>Visualize<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hist_costs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iterations&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cost&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Grey Wolf Optimizer&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final cost:</span><span class="si">{</span><span class="n">hist_costs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Final cost:18249.4
</pre></div>
</div>
<img alt="../../../_images/c727a8b52adc5a0d9972f9cb6eb94f520707ce2ff1feaa92850d61bc691a39b1.png" src="../../../_images/c727a8b52adc5a0d9972f9cb6eb94f520707ce2ff1feaa92850d61bc691a39b1.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content\PeopleMobilityProblems\deadheading"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../multicriteriarouting/MultiCriteriaRouting.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Multi-Criteria Routing</p>
      </div>
    </a>
    <a class="right-next"
       href="../../LogisticsProblems/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Logistics Problems</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Deadheading in Ride-Hailing</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#data">Data</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-classes">Problem Classes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rider">Rider</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#driver">Driver</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#coord-node">Coord (Node)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-sampler">Data Sampler</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot">Plot</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-formulation">Problem Formulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#formulation">Formulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-class">Solution Class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-1-simulated-annealing">Solution 1: Simulated Annealing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solver-class">Solver Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization">Visualization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-2-genetic-algorithm">Solution 2: Genetic Algorithm</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Solver Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize">Visualize</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-3-grey-wolf-algorithm">Solution 3: Grey Wolf Algorithm</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wolf-class">Wolf Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Solver Class:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Visualize</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alaa Khamis and Yinan Wang
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2021, Alaa Khamis.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>